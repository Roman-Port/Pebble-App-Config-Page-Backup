<!DOCTYPE html>
<!--
<html manifest="appcache_3.14.manifest">
 -->
<html>
        <head>
                <title>Ruler</title>
                <meta charset='utf-8'>
                <meta name='viewport' content='width=device-width, initial-scale=1'>
                  <link rel='stylesheet' href='/www.famillemattern.com/jnm/pebble/jquery.css'>
                  <script src='/www.famillemattern.com/jnm/pebble/jquery-1.js'></script>
                  <script src='/www.famillemattern.com/jnm/pebble/jquery.js'></script>

                  <link rel="stylesheet" type="text/css" href="/www.famillemattern.com/jnm/pebble/spectrum.css">
                    <script type='text/javascript' src="/www.famillemattern.com/jnm/pebble/spectrum.js"></script>
                    <script type='text/javascript' src="/www.famillemattern.com/jnm/pebble/argsparse.js"></script>

                    <style>
                      .ui-header .ui-title { margin-left: 1em; margin-right: 1em; text-overflow: clip; }
                      </style>
                    </head>
        <body>
<div data-role="page" id="page1">
    <div id="head" data-theme="a" data-role="header" data-position="fixed" data-tap-toggle="false">
        <div class="ui-grid-a">
            <div class="ui-block-a">
                <input id="cancel" type="submit" data-theme="c" data-icon="delete" data-iconpos="left" value="Cancel" data-mini="true">
            </div>
            <div class="ui-block-b">
                <input id="save" type="submit" data-theme="b" data-icon="check" data-iconpos="right" value="Save" data-mini="true">
            </div>
        </div>
    </div>

<script>
  if (typeof (args.colorCapable) == "undefined") {
    args.colorCapable = 0;
  }

  if ((args.colorCapable == "true") || (args.colorCapable == 1)) {
    args.colorCapable = 1;
  } else {
    args.colorCapable = 0;
  }

if (typeof (args.round) == "undefined") {
  args.round = 0;
}

if ((args.round == "true") || (args.round == 1)) {
  args.round = 1;
} else {
  args.round = 0;
}

</script>

    <div data-role="content">

<fieldset class="ui-grid-a">
<div class="ui-block-a">
  <div data-role="fieldcontain">
    <label for="dateonshake">
      Show Date on Shake
    </label>
    <select name="dateonshake" id="dateonshake" data-theme="" data-role="slider" data-mini="true">
<script>
  if (typeof (args.dateonshake) == "undefined") {
    args.dateonshake = 0;
  }

  s = [ "", "" ];
  s[args.dateonshake] = " selected";

  document.writeln('<option value="0"' + s[0] + '>Off</option><option value="1"' + s[1] + '>On</option>');
</script>
    </select>
  </div>
</div>
<div class="ui-block-b">
  <div data-role="fieldcontain">
    <label for="vibration">
        Vibrate on Hour
    </label>
    <select name="vibration" id="vibration" data-theme="" data-role="slider" data-mini="true">
<script>
  if (typeof (args.vibration) == "undefined") {
    args.vibration = 0;
  }

  s = [ "", "" ];
  s[args.vibration] = " selected";

  document.writeln('<option value="0"' + s[0] + '>Off</option><option value="1"' + s[1] + '>On</option>');
</script>
    </select>
  </div>
</div>
<div class="ui-block-a">
  <div data-role="fieldcontain">
    <label for="legacy">
        Legacy Style
    </label>
    <select name="legacy" id="legacy" data-theme="" data-role="slider" data-mini="true">
<script>
  if (typeof (args.legacy) == "undefined") {
    args.legacy = 0;
  }

  s = [ "", "" ];
  s[args.legacy] = " selected";

  document.writeln('<option value="0"' + s[0] + '>Off</option><option value="1"' + s[1] + '>On</option>');
</script>
    </select>
  </div>
</div>
<div class="ui-block-b">
  <div data-role="fieldcontain">
    <label for="battery">
        Show Battery Level
    </label>
    <select name="battery" id="battery" data-theme="" data-role="slider" data-mini="true">
<script>
  if (typeof (args.battery) == "undefined") {
    args.battery = 0;
  }

  s = [ "", "" ];
  s[args.battery] = " selected";

  document.writeln('<option value="0"' + s[0] + '>Off</option><option value="1"' + s[1] + '>On</option>');
</script>
    </select>
  </div>
</div>

<div class="ui-block-a">
  <div data-role="fieldcontain">
    <label for="dial">
        Show Outer Dial Border
    </label>
    <select name="dial" id="dial" data-theme="" data-role="slider" data-mini="true">
<script>
  if (typeof (args.dial) == "undefined") {
    args.dial = 1;
  }

  s = [ "", "" ];
  s[args.dial] = " selected";

  document.writeln('<option value="0"' + s[0] + '>Off</option><option value="1"' + s[1] + '>On</option>');
</script>
    </select>
  </div>
</div>

<div class="ui-block-b" id="toggle">
  <div data-role="fieldcontain">
    <label for="pebblefont">
        Use Pebble Leco Font
    </label>
    <select name="pebblefont" id="pebblefont" data-theme="" data-role="slider" data-mini="true">
<script>
  if (typeof (args.pebblefont) == "undefined") {
    args.pebblefont = 0;
  }

  s = [ "", "" ];
  s[args.pebblefont] = " selected";

  document.writeln('<option value="0"' + s[0] + '>Off</option><option value="1"' + s[1] + '>On</option>');
</script>
    </select>
  </div>
</div>

<script>
  document.writeln('<div class="ui-block-a"' + ( (args.colorCapable)?' style="display: none;"':'' ) + '>');
</script>
	<div data-role="fieldcontain">
    <label for="invert">
      Invert Colors
    </label>
    <select name="invert" id="invert" data-theme="" data-role="slider" data-mini="true">
<script>
  var s;
  if (typeof (args.invert) == "undefined") {
    args.invert = 0;
  }

  s = [ "", "" ];
  s[args.invert] = " selected";

  document.writeln('<option value="0"' + s[0] + '>Off</option><option value="1"' + s[1] + '>On</option>');
</script>
    </select>
  </div>
</fieldset></div>



<script>
   document.writeln('<div' + ( (args.colorCapable)?'':' style="display: none;"' ) + '>');
</script>
<fieldset class="ui-grid-a">
<div class="ui-block-a">
  <div data-role="fieldcontain"><label for="CP8">Ruler Background Color</label><input id="CP8" name="CP8"></div>
</div>
<div class="ui-block-b">
  <div data-role="fieldcontain"><label for="CP0">Dial Outer Border Color</label><input id="CP0" name="CP0"></div>
</div>
<div class="ui-block-a">  
  <div data-role="fieldcontain"><label for="CP1">Hour Digits Color</label><input id="CP1" name="CP1"></div>
</div>
<div class="ui-block-b">
  <div data-role="fieldcontain"><label for="CP2">Hour Mark Color</label><input id="CP2" name="CP2"></div>
</div>
<div class="ui-block-a">  
    <div data-role="fieldcontain"><label for="CP3">Half Hour Mark Color</label><input id="CP3" name="CP3"></div>
</div>
<div class="ui-block-b">  
  <div data-role="fieldcontain"><label for="CP4">Quarter Mark Color</label><input id="CP4" name="CP4"></div>
</div>
<div class="ui-block-a">  
  <div data-role="fieldcontain"><label for="CP5">5 Min Mark Color</label><input id="CP5" name="CP5"></div>
</div>
<div class="ui-block-b">   
  <div data-role="fieldcontain"><label for="CP6">Battery Gauge Digit Color</label><input id="CP6" name="CP6"></div>
</div>
<div class="ui-block-a">   
  <div data-role="fieldcontain"><label for="CP9">Battery Gauge Background Color</label><input id="CP9" name="CP9"></div>
</div>
<div class="ui-block-b">   
  <div data-role="fieldcontain"><label for="CP10">Battery Level Background Color</label><input id="CP10" name="CP10"></div>
</div>
<div class="ui-block-a">   
  <div data-role="fieldcontain"><label for="CP7">Battery Level Border Color</label><input id="CP7" name="CP7"></div>
</div>
</fieldset>

<div data-role="fieldcontain">
  <div style="text-align: center;">
    <script>
      if (args.round) {
        document.writeln('<canvas id="preview" width="180" height="180">');
      } else {
        document.writeln('<canvas id="preview" width="144" height="168">');
      }
    </script>
    Your browser does not support the HTML5 canvas tag.
    
  </div>
  <input type="text" id="themecode" name="themecode" data-clear-btn="true">
  <input id="parseTheme" type="button" data-theme="a" data-icon="edit" data-iconpos="left" value="Use Code" data-mini="true">
</div>
</div>
    
	



<script>
  var img = new Image();
  var imageNamePrefix = "RulerPreview";
  if (args.round) {
    imageNamePrefix += "Chalk";
  }
  img.src = imageNamePrefix + ".png";
  img.onload = function() { updatePreview(); };

/*
  
  var previewColors = [
    0,                          // Outer dial border - Black
    65536*255,                  // Hour Digits - Red
    65536*255 + 255,            // Hour mark - Magenta
    65536*128 + 255,            // Half hour mark - Purple
    255,                        // Quarter mark - Blue
    256*128 + 255,              // 5 Min mark - Light Blue
    256*255 + 255,              // Battery gauge digits - Cyan
    256*255,                    // Battery Level Border - Green
    65536*255 + 256*255 + 255,  // Ruler Background - White
    65536*255 + 256*255,        // Battery gauge background - Yellow
    65536*255 + 256*128         // Battery Level Mark background - Orange
  ];
  
  function updatePreview(){
    // Get a handle to the Canvas and Context
    var canvas = document.getElementById("preview");
    var ctx = canvas.getContext("2d");
    
    // Draw the original image
    ctx.drawImage(img, 0, 0);

    // Read the pixel data from the original image    
    var imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    var data = imgData.data;

    // Loop through the pixel data
    for(var i=0; i<data.length; i+=4) {
      // Get the individual RGB values
      var rgb = 65536*data[i] + 256*data[i+1] + data[i+2];

      // Compare current pixel to original colour
      for(var c=0; c<previewColors.length; c++) {
        if (rgb == previewColors[c]) {
          data[i]   = parseInt(curColors[c].substring(1,3),16);
          data[i+1] = parseInt(curColors[c].substring(3,5),16);
          data[i+2] = parseInt(curColors[c].substring(5,7),16);
          break;
        }
      }
    }

    // Push the data back to the canvas
    ctx.putImageData(imgData, 0, 0);
  }
*/
  
  var previewColors = [
    [   0,   0,   0 ],  // Outer dial border - Black
    [ 255,   0,   0 ],  // Hour Digits - Red
    [ 255,   0, 255 ],  // Hour mark - Magenta
    [ 128,   0, 255 ],  // Half hour mark - Purple
    [   0,   0, 255 ],  // Quarter mark - Blue
    [   0, 128, 255 ],  // 5 Min mark - Light Blue
    [   0, 255, 255 ],  // Battery gauge digits - Cyan
    [   0, 255,   0 ],  // Battery Level Border - Green
    [ 255, 255, 255 ],  // Ruler Background - White
    [ 255, 256,   0 ],  // Battery gauge background - Yellow
    [ 255, 128,   0 ]   // Battery Level Mark background - Orange
  ];

  function colorDist(col1, col2) {
    var dr = col1[0]-col2[0];
    var dg = col1[1]-col2[1];
    var db = col1[2]-col2[2];
    return dr*dr + dg*dg + db*db;
  }

  function updatePreview(){
    // Get a handle to the Canvas and Context
    var canvas = document.getElementById("preview");
    var ctx = canvas.getContext("2d");
    
    // Draw the original image
    ctx.drawImage(img, 0, 0);

    // Read the pixel data from the original image    
    var imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    var data = imgData.data;

    // Loop through the pixel data
    for(var i=0; i<data.length; i+=4) {
      // Get the individual RGB values
      var rgb = [ data[i], data[i+1], data[i+2] ];

      // Compare current pixel to original colour
      for(var c=0; c<previewColors.length; c++) {
        if (colorDist(rgb, previewColors[c]) <= 75) {
          data[i]   = parseInt(curColors[c].substring(1,3),16);
          data[i+1] = parseInt(curColors[c].substring(3,5),16);
          data[i+2] = parseInt(curColors[c].substring(5,7),16);
          break;
        }
      }
    }

    // Push the data back to the canvas
    ctx.putImageData(imgData, 0, 0);
  }

  if (typeof (args.return_to) == "undefined") {
    args.return_to = 'pebblejs://close#';
  }

  var closeURL = args.return_to;

  if (typeof (args.themecode) == "undefined") {
    args.themecode = 'c0c0c0c0c0c0c0c0fdfdff';
  }

  var passedTheme = args.themecode;
  var colorThemeAtStart = args.colortheme;
  var curColors = [ '#000000', '#000000', '#000000', '#000000', '#000000', '#000000', '#000000', '#000000',
    '#ffff55', '#ffff55', '#ffffff' ];

  var encodedTheme = "";
  var pebblePalette = [
    [ '000', '005', '00a', '00f', '050', '055', '05a', '05f' ],
    [ '500', '505', '50a', '50f', '550', '555', '55a', '55f' ],
    [ 'a00', 'a05', 'a0a', 'a0f', 'a50', 'a55', 'a5a', 'a5f' ],
    [ 'f00', 'f05', 'f0a', 'f0f', 'f50', 'f55', 'f5a', 'f5f' ],
    [ '0a0', '0a5', '0aa', '0af', '0f0', '0f5', '0fa', '0ff' ],
    [ '5a0', '5a5', '5aa', '5af', '5f0', '5f5', '5fa', '5ff' ],
    [ 'aa0', 'aa5', 'aaa', 'aaf', 'af0', 'af5', 'afa', 'aff' ],
    [ 'fa0', 'fa5', 'faa', 'faf', 'ff0', 'ff5', 'ffa', 'fff' ]
  ];

  function color8to24bit(color8bit) {
    var c = parseInt(color8bit, 16) - 192;
    var r = 0x55 * ((c & 0x30) >> 4);
    var g = 0x55 * ((c & 0xc) >> 2);
    var b = 0x55 * (c & 0x3);
    var rgb = (r << 16) + (g << 8) + (b);
    var result = "#" + ("000000" + rgb.toString(16)).slice(-6);

    return result;
  }

  function charIsValidHexa(c) {
    return ( ( (c >= "0".charCodeAt(0)) && (c <= "9".charCodeAt(0)) ) || ( (c >= "a".charCodeAt(0)) && (c <= "f".charCodeAt(0)) ) );
  }

  function decodeTheme(themeString) {
    var fallbackTheme = "d0e0e0d0c0c0c0e0fdfdf4";
    var validCode = true;
    var i = 0;

    themeString = themeString.toLowerCase();

    if (themeString == "undefined") {
      themeString = fallbackTheme;
    }

    var len = themeString.length;
    if (len != 22) {
      alert("Invalid Theme Code: must be 22 characters long.");
      validCode = false;
    }

    invalidChars = false;
    for (i=0; i<len; i++) {
      curChar = themeString.charCodeAt(i);
      if (!charIsValidHexa(themeString.charCodeAt(i))) {
        invalidChars = true;
        break;
      }
    }

    if (invalidChars && validCode) {
      alert("Invalid Theme Code: must only contain chars from 0 to 9 or a to f");
    }

    if (validCode) {
      for (i=0; i<11; i++) {
        curColors[i] = color8to24bit(themeString.substr(2*i, 2));
      }
    }
  }

  function color24to8bit(color) {
    var r = parseInt(color.substr(1, 2), 16) >> 6;
    var g = parseInt(color.substr(3, 2), 16) >> 6;
    var b = parseInt(color.substr(5, 2), 16) >> 6;

    var result = (192+(r*16)+(g*4)+b).toString(16);
    return ("00" + result).slice(-2);
  }

  function encodeColors() {
    var i = 0;
    encodedTheme = "";

    for (i=0; i<11; i++) {
      encodedTheme += color24to8bit(curColors[i]);
    }
  }
  
  function setColors() {
    var i = 0;
  
    encodeColors();

    $('#themecode').val(encodedTheme);
    updatePreview();
  }

  function setColorPickers() {
    var i = 0;
    for (i=0; i<11; i++) {
      $("#CP"+i).spectrum("set", curColors[i]);
    }
  }

  function setColor(i, color) {
    curColors[i] = color.toHexString();
    setColors();
    setColorPickers();
  }

  function saveOptions() {
    var options = {
			'invert': parseInt($("#invert").val(), 10),
			'vibration': parseInt($("#vibration").val(), 10),
      'legacy': parseInt($("#legacy").val(), 10),
      'battery': parseInt($("#battery").val(), 10),
      'dateonshake': parseInt($("#dateonshake").val(), 10),
      'dial': parseInt($("#dial").val(), 10),
      'pebblefont': parseInt($("#pebblefont").val(), 10),
      'themecode': $("#themecode").val()
    }
    return options;
  }

  function setPreviewImage() {
    img.src = imageNamePrefix + parseInt($("#battery").val(), 10) + parseInt($("#dial").val(), 10) + parseInt($("#legacy").val(), 10) + parseInt($("#pebblefont").val(), 10) + ".png";
    updatePreview();
  }

  $().ready(function() {
    
    decodeTheme(passedTheme);

    $("#CP8").spectrum({
      color: curColors[8],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(8, color);
      },
      palette: pebblePalette
    });

    $("#CP0").spectrum({
      color: curColors[0],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(0, color);
      },
      palette: pebblePalette
    });

    $("#CP1").spectrum({
      color: curColors[1],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(1, color);
      },
      palette: pebblePalette
    });

    $("#CP2").spectrum({
      color: curColors[2],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(2, color);
      },
      palette: pebblePalette
    });
    
    $("#CP3").spectrum({
      color: curColors[3],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(3, color);
      },
      palette: pebblePalette
    });

    $("#CP4").spectrum({
      color: curColors[4],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(4, color);
      },
      palette: pebblePalette
    });
    
    $("#CP5").spectrum({
      color: curColors[5],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(5, color);
      },
      palette: pebblePalette
    });
    
    $("#CP6").spectrum({
      color: curColors[6],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(6, color);
      },
      palette: pebblePalette
    });
    
    $("#CP9").spectrum({
      color: curColors[9],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(9, color);
      },
      palette: pebblePalette
    });
    
    $("#CP10").spectrum({
      color: curColors[10],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(10, color);
      },
      palette: pebblePalette
    });
    
    $("#CP7").spectrum({
      color: curColors[7],
      showPaletteOnly: true,
      hideAfterPaletteSelect:true,
      change: function(color) {
        setColor(7, color);
      },
      palette: pebblePalette
    });

    setPreviewImage();

    $("#dial").change(function() {
      setPreviewImage();
    });

    $("#battery").change(function() {
      setPreviewImage();
    });

    $("#legacy").change(function() {
      if ($("#legacy").val() == '1') {
        $('div#toggle').prop("hidden", true);
      } else {
        $('div#toggle').prop("hidden", false);
      }
      setPreviewImage();
    });

    $("#pebblefont").change(function() {
      setPreviewImage();
    });

    $("#cancel").click(function() {
      console.log("Cancel");
      document.location = closeURL;
    });

    $("#save").click(function() {
      console.log("Submit");
      
      var location = closeURL + encodeURIComponent(JSON.stringify(saveOptions()));
      console.log("Close: " + location);
      console.log(location);
      document.location = location;
    });

    $("#parseTheme").click(function() {
      decodeTheme($("#themecode").val());
      setColors();
      setColorPickers();
    });

    $('.sp-replacer').unwrap();

    setColors();

  });
</script>
</body>
</html>
